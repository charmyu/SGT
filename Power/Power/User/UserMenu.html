<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>上海恒劲动力科技有限公司</title>
    <link rel="shortcut icon" href="../favicon.ico" />
    <link href="../js/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css">
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/font-awesome.min93e3.css" rel="stylesheet" />
    <link href="../css/plugins/iCheck/custom.css" rel="stylesheet" />
    <link href="../css/common.css" rel="stylesheet" />
    <link href="../css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="../css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet" />
    <link href="../js/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="../js/lib/ligerUI/skins/Gray/css/all.css" rel="stylesheet" type="text/css" />
    <script src="../js/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/core/base.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerGrid.js"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerToolBar.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerDialog.js" type="text/javascript"></script>
    <script src="../js/json2.js"></script>
    <script src="../js/jquery/ligerUI/ligerui.all.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/plugins/iCheck/icheck.min.js"></script>
    <link href="../js/ztree/css/demo.css" rel="stylesheet" />
    <link href="../js/ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
    <script src="../js/ztree/js/jquery.ztree.core.js"></script>
    <script src="../js/ztree/js/jquery.ztree.excheck.js"></script>
    <script src="../js/plugins/sweetalert/sweetalert.min.js"></script>
    <script src="../js/Jquery/jquery-validation/jquery.validate.min.js"></script>
    <script src="../js/Jquery/jquery-validation/messages_cn.js"></script>
    <script src="../js/Jquery/jquery-validation/jquery.validate.additional.js"></script>
    <script src="../js/Jquery/jquery-validation/jquery.metadata.js"></script>
    <script src="../js/lib/ligerUI/js/core/inject.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerCheckBox.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerListBox.js" type="text/javascript"></script>
   
</head>
<body class="gray-bg">
    <div class="col-sm-12">
        <div class="ibox float-e-margins">
            <div class="ibox-title">
                <div style="width: 260px; float: left;">
                    <h4>
                        用户类型列表
                    </h4>
                </div>
                <div style="width: 300px; float: left;">
                    <h4>
                        功能菜单列表
                    </h4>
                </div>
                    <button id="btnSave" onclick="Save()" class="btn btn-primary">&nbsp;&nbsp;保存&nbsp;&nbsp;</button>
               </div>
            <div class="ibox-content">

                <table>
                    <tr>
                        <td>
                                    <div id="listbox1" class="l-listbox" style="width: 200px; height: 320px;">
                                        <div class="l-listbox-inner">
                                            <table cellpadding="0" cellspacing="0" border="0" class="l-listbox-table l-table-nocheckbox"></table>

                                        </div><input type="hidden" name="listbox1_val" id="listbox1_val" data-ligerid="listbox1">
                                    </div>
                                


                        </td>
                        <td style ="width:50px;">&nbsp;</td>
                        <td style="width: 320px;">
                            <div >
                                <ul  id="treeDemo" class="ztree"></ul>
                            </div>
                        </td>
                        <td style="vertical-align:bottom">

                           
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</body>
</html>

<script>

    //tree 参数
    var setting = {
        check: {
            enable: true
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        //callback: {
        //    onClick: onClick
        //}
    };
    //页面加载完成执行
    $(document).ready(function () {

        bindTree();
        bindUserType();
    });

    //绑定机构treeview
    function bindTree() {
        $.ajax({
            type: "GET",
            url: "/api/MenuInfo/GetMenuInfo",
            dataType: "json",
            success: function (data) {
                var jsonstr = "[]";
                var jsonarray = eval('(' + jsonstr + ')');
                var zNodes;
                var result = eval("(" + data + ")");
                $(result.Rows).each(function (key) {

                    var node = { "id": "" + result.Rows[key].Menu_ID + "", "pId": "" + result.Rows[key].Menu_Parent + "", "name": "" + result.Rows[key].Menu_Name + "", "open": "true" };
                    jsonarray.push(node);
                });


                $.fn.zTree.init($("#treeDemo"), setting, jsonarray);
            },
            error: function (data) {
                swal("TREE绑定出错");
            }
        });

    }
    var rdval = "";
    var getData = null;
    //机构树点击事件
    function onClick(event, treeId, treeNode, clickFlag) {

        // $("#hiddepID").val(treeNode.id);
        var str = "";
        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
             nodes = zTree.getChangeCheckedNodes(true);
        for (var i = 0, l = nodes.length; i < l; i++) {
            str += nodes[i].name;
        }
        swal(str);
    }

    var usertype = [];

    function bindUserType() {
        $.ajax({
            type: "GET",
            url: "/api/Sys_UserType/GetAllUserType",
            dataType: "json",
            success: function (data) {

                var result = eval("(" + data + ")");
                $(result.Rows).each(function (key) {
                    usertype.push({
                        id: result.Rows[key].typeId,
                        text: result.Rows[key].typename
                    });
                });
                bindListBox();
            },
            error: function (data) {
                swal("用户类型绑定出错");
            }
        });

    }

    function bindListBox() {
        $("#listbox1").ligerListBox({
            isShowCheckBox: false, isMultiSelect: false, height: 300,
            width: 200,
            onSelected: function (id) {
                if (id != undefined)
                loadTreeData(id);
            }
        });
        var box1 = liger.get("listbox1");
        box1.clear();
        box1.clearContent();
        box1.setData(usertype);
    };
    function loadTreeData(id) {
      
        $.ajax({
            type: "GET",
            url: "/api/User_Menu/GetUserTypeMenu?typeid=" + id,
            dataType: "json",
            success: function (data) {
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");
                var nodes = treeObj.transformToArray(treeObj.getNodes());
                treeObj.checkAllNodes(false);
                var result = eval("(" + data + ")");
                $(result.Rows).each(function (key) {
                   
                    for (var i = 0;i< nodes.length; i++) {
                        if (result.Rows[key].MenuID == nodes[i].id)
                        {
                            if (!nodes[i].isParent) {
                                treeObj.checkNode(nodes[i], true, true, true);
                            }
                        }
                    }

                });
               
            },
            error: function (data) {
                swal("绑定出错");
            }
        });

    }
  



    //保存数据
    function Save() {
        var uid = "";
        var box1 = liger.get("listbox1");
        var selecteds = box1.getSelectedItems();
        if (!selecteds || !selecteds.length) return; 
            uid= selecteds[0].id;

        var str = "";
        var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
             nodes = zTree.getChangeCheckedNodes(true);
        for (var i = 0, l = nodes.length; i < l; i++) {
            str += nodes[i].id+",";
        }
       // swal(str);

        if (str != ""&&uid!="") {
            $.ajax({
                type: "POST",
                url: "/api/User_Menu/SaveUsertypeMenu?usertypeid=" + uid + "&menuidlist=" + str,
                dataType: "json",
                success: function (result) {
                    var val = result;
                    if (val == "OK") {
                        swal('编辑成功!');
                        UID = "";
                    }

                },
                error: function () {
                   
                }
            });
        }
        else {
            swal("请选择用户类型和功能页面！");
        }

    }
</script>
