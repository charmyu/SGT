<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>上海恒劲动力科技有限公司</title>
    <link rel="shortcut icon" href="../favicon.ico" />
    <link href="../js/lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css">
    <link href="../css/bootstrap.min.css" rel="stylesheet" />
    <link href="../css/font-awesome.min93e3.css" rel="stylesheet" />
    <link href="../css/plugins/iCheck/custom.css" rel="stylesheet" />
    <link href="../css/common.css" rel="stylesheet" />

    <link type="text/css" rel="stylesheet" href="../js/plugins/layer/laydate/need/laydate.css">
    <link type="text/css" rel="stylesheet" href="../js/plugins/layer/laydate/skins/default/laydate.css">
    <link href="../css/plugins/sweetalert/sweetalert.css" rel="stylesheet" />
    <link href="../css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet" />
    <link href="../js/lib/ligerUI/skins/Aqua/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="../js/lib/ligerUI/skins/Gray/css/all.css" rel="stylesheet" type="text/css" />
    <script src="../js/lib/jquery/jquery-1.9.0.min.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/core/base.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerGrid.js"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerDrag.js" type="text/javascript"></script>
    <script src="../js/lib/ligerUI/js/plugins/ligerResizable.js" type="text/javascript"></script>

    <script src="../js/plugins/layer/laydate/laydate.js"></script>
    <script src="../js/plugins/iCheck/icheck.min.js"></script>
    <link href="../js/ztree/css/demo.css" rel="stylesheet" />
    <link href="../js/ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
    <script src="../js/ztree/js/jquery.ztree.core.js"></script>
    <script src="../js/plugins/sweetalert/sweetalert.min.js"></script>
    <script src="../js/common.js"></script>
    <script type="text/javascript" src="../js/ichart/ichart.1.2.min.js"></script>
    <link rel="stylesheet" href="../js/ichart/css/demo.css" type="text/css" />

    <script type="text/javascript">
        var setting = {
            view: {
                dblClickExpand: false
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            callback: {
                onClick: onClick
            }
        };


        function onClick(e, treeId, treeNode) {
            var zTree = $.fn.zTree.getZTreeObj("treeDemo"),
			nodes = zTree.getSelectedNodes(),
			v = "";
            nodes.sort(function compare(a, b) { return a.id - b.id; });
            for (var i = 0, l = nodes.length; i < l; i++) {
                v = nodes[i].name;
                $("#department").val(nodes[i].id);
            }
            //if (v.length > 0 ) v = v.substring(0, v.length-1);
            var cityObj = $("#citySel");
            cityObj.val(v);
            hideMenu();
            BindDevice($("#department").val());
        }

        function showMenu() {
            var cityObj = $("#citySel");
            var cityOffset = $("#citySel").offset();
            $("#menuContent").css({ left: cityOffset.left + "px", top: cityOffset.top + cityObj.outerHeight() + "px" }).slideDown("fast");

            $("body").bind("mousedown", onBodyDown);
        }
        function hideMenu() {
            $("#menuContent").fadeOut("fast");
            $("body").unbind("mousedown", onBodyDown);
        }
        function onBodyDown(event) {
            if (!(event.target.id == "citySel" || event.target.id == "menuContent" || $(event.target).parents("#menuContent").length > 0)) {
                hideMenu();
            }
        }

        $(document).ready(function () {
            $(".i-checks").iCheck({ checkboxClass: "icheckbox_square-green", radioClass: "iradio_square-green", });
            laydate({
                elem: "#start",
                event: "focus"
            });
            var d = new Date(), str = '';
            str += padleft0(d.getFullYear()) + '-';
            str +=padleft0( d.getMonth() + 1) + '-';
            str +=padleft0( d.getDate()) ;
            $("#start").val(str);
            bindTree();
            //  binduser();
        });

        //绑定机构treeview
        function bindTree() {
            $.ajax({
                type: "POST",
                url: "/api/Department/DepartmentByUser",
                dataType: "json",
                success: function (data) {
                    var jsonstr = "[]";
                    var jsonarray = eval('(' + jsonstr + ')');
                    var zNodes;
                    var result = eval("(" + data + ")");
                    $(result.Rows).each(function (key) {

                        var node = { "id": "" + result.Rows[key].Dep_ID + "", "pId": "" + result.Rows[key].Dep_Parent + "", "name": "" + result.Rows[key].Dep_Name + "", "open": "true" };
                        jsonarray.push(node);
                    });


                    $.fn.zTree.init($("#treeDemo"), setting, jsonarray);
                },
                error: function (data) {
                    swal('提示', 'TREE绑定出错！', 'error');
                }
            });

        }

        function padleft0(obj) {
            return obj.toString().replace(/^[0-9]{1}$/, "0" + obj);
        }
    </script>
    <style>
        .toolbar {
            border-bottom: 2px solid #666;
            padding-bottom: 50px;
            margin-bottom: 50px;
        }

        table {
            border-bottom: 1px solid #ccc;
        }

        .toolbar label {
            display: inline-block;
            height: 34px;
            line-height: 34px;
        }

        table tbody tr:hover {
            background: #ccc;
        }

        .table {
            margin-bottom: 6px;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <label style="float: left;">用户机构：</label>
        <div style="float: left;margin:0 6px;width:280px;">
            <div class="col-sm-3">
                <input id="citySel" type="text" name="citySel" onclick="showMenu(); return false;" class="form-control" readonly value="" style="width:200px;" />

            </div>
            <div id="menuContent" class="menuContent" style="display:none; position: absolute; z-index:100">
                <ul id="treeDemo" class="ztree" style="margin-top:0; width:200px;"></ul>
            </div>
            <input id="department" type="hidden" />
        </div>
        <label style="float: left;">基站名称：</label>
        <div style="float: left;margin:0 6px;width:150px;">
            <select id="ddlname" class="form-control" style="width: 150px;"></select>

        </div>
        <label style="float: left;">模块：</label>
        <div style="float: left;margin:0 6px;width:150px;">
            <select id="ddlmodule" class="form-control" style="width: 150px;"></select>

        </div>
        <label style="float: left;">参数：</label>
        <div style="float: left;margin:0 6px;width:150px;">
            <select id="ddlparam" class="form-control" style="width: 150px;"></select>

        </div>
        <button id="btnSearch" class="btn btn-success" onclick="f_search()"><i class="icon-magnifier"></i>搜索</button>

        <button id="btnExport" class="btn btn-success" onclick="f_export()"><i class="icon-magnifier"></i>导出</button>
        

        <div style="top:50px; position:absolute;">
            <label style="float: left;">日期：</label>
            <div style="float: left;margin:0 6px;width:200px;">
                <input id="start" class="laydate-icon form-control layer-date" placeholder="开始日期">
            </div>
            <div class="form-horizontal" style="float: left;margin: 0 6px; width: 200px;">
                <div style="float: left;" class="radio i-checks">
                    <label> <input type="radio" value="day" name="rddep"> <i></i> 日数据</label>
                </div>
                <div style="float: left;" class="radio i-checks">
                    <label><input type="radio" checked="" value="month" name="rddep"> <i></i> 月数据</label>
                </div>
            </div>
            <label style="float: left;">数据计算方式：</label>
            <div class="form-horizontal" style="float: left;margin: 0 6px; width: 300px;">
                <div style="float: left;" class="radio i-checks">
                    <label> <input type="radio" value="max" name="fun"> <i></i> 最大值</label>
                </div>
                <div style="float: left;" class="radio i-checks">
                    <label><input type="radio" value="min" name="fun"> <i></i> 最小值</label>
                </div>
                <div style="float: left;" class="radio i-checks">
                    <label><input type="radio" checked="" value="avg" name="fun"> <i></i> 平均值</label>
                </div>
            </div>
        </div>
    </div>
    <div style="float: left;" id='canvasDiv'></div>
</body>
</html>
<script>
        //绑定模板名称下拉框
    function BindDevice(depid) {

                $.ajax({
                    type: "POST",
                    url: "/api/Device/DeviceByDepID?depID="+depid,
                    dataType: "json",
                    success: function (data) {
                        $("#ddlname").empty();
                        var ddl = $("#ddlname");
                        //ddl.append("<option value=''>请选择...</option>");
                        var result = eval("(" + data + ")");
                        $(result.Rows).each(function (key) {
                            ddl.append('<option value="' + result.Rows[key].ID + '">' + result.Rows[key].stationname + '</option>');
                        });
                        ddlBind($("#ddlname").val());
                    ddl.bind("change", function () {
                        ddlBind($("#ddlname").val());
                    });
                },
                error: function (data) {
                    swal("下拉框绑定出错");
                }
            });
        }

        function ddlBind(devid)
        {
            $.ajax({
                type: "POST",
                url: "/api/Module/ModuleByDeviceId?deviceid=" + devid,
                dataType: "json",
                success: function (data) {
                    $("#ddlmodule").empty();
                    var ddl = $("#ddlmodule");
                    var result = eval("(" + data + ")");
                    $(result.Rows).each(function (key) {
                        ddl.append('<option value="' + result.Rows[key].NO + '">' + result.Rows[key].ModuleName + '</option>');
                    });
                    ddlBindParam(devid, $("#ddlmodule").val());
                    ddl.bind("change", function () {
                        ddlBindParam(devid,$("#ddlmodule").val());
                    });
                },
                error: function (data) {
                    swal("下拉框绑定出错！");
                }
            });
        }
        function ddlBindParam(devid,senderID) {
            $.ajax({
                type: "GET",
                url: "/api/Parameter/GetParameterByDeviceID?devID=" + devid + "&senderID=" + senderID,
                dataType: "json",
                success: function (data) {
                    $("#ddlparam").empty();
                    var ddl = $("#ddlparam");
                    var result = eval("(" + data + ")");
                    $(result.Rows).each(function (key) {
                        ddl.append('<option value="' + result.Rows[key].ParamID + '">' + result.Rows[key].parametername + '</option>');
                    });
                  
                },
                error: function (data) {
                    swal("下拉框绑定出错！");
                }
            });
        }
        function f_search()
        {
            var devid = $("#ddlname").val();
            var pID = $("#ddlparam").val();
            $.ajax({
                type: "GET",
                url: "/api/HistoricalData/GetLineData?devID=" + devid + "&paramID=" + pID + "&tm=" + $("#start").val() + "&date=" + $("input[name='rddep']:checked").val() + "&fun=" + $("input[name='fun']:checked").val(),
                dataType: "json",
                success: function (data) {
                     labels = [];
                     flow = [];

                    var result = eval("(" + data + ")");
                    $(result.Rows).each(function (key) {
                        flow.push(result.Rows[key].Val);
                        labels.push(result.Rows[key].TM);
                    });
                    lineData();
                },
                error: function (data) {
                    swal("数据加载出错！"); 
                }
            });

        }

        function f_export() {
            var devid = $("#ddlname").val();
            var pID = $("#ddlparam").val();
            $.ajax({
                type: "post",
                url: "/api/HistoricalData/ExportLine?devID=" + devid + "&paramID=" + pID + "&tm=" + $("#start").val() + "&date=" + $("input[name='rddep']:checked").val() + "&fun=" + $("input[name='fun']:checked").val(),
                dataType: "json",
                success: function (data) {
                    if (data == true)
                        alert("导出成功");
                },
                error: function (data) {
                    swal("数据加载出错！");
                }
            });
        }
        
    //绑定曲线图
        var labels = [];
        var flow = [];
       
       function lineData() {
          
           var data = [
                       {
                           name: $("#ddlparam").find("option:selected").text(),
                           value: flow,
                           color: '#0d8ecf',
                           line_width: 2
                       }
           ];
            
           var chart = new iChart.LineBasic2D({
                render: 'canvasDiv',
                data: data,
                align: 'center',
                title: {
                    text: ' ',
                    fontsize: 24,
                    color: '#f7f7f7'
                },
                //subtitle: {
                //    text: '最大值(单位：万)',
                //    color: '#f1f1f1'
                //},
                //footnote: {
                //    text: '数据来源：模拟数据',
                //    color: '#f1f1f1'
                //},
                width: 1000,
                height: 500,
                shadow: true,
                shadow_color: '#20262f',
                shadow_blur: 4,
                shadow_offsetx: 0,
                shadow_offsety: 2,
                background_color: '#383e46',
                tip: {
                    enable: true,
                    shadow: true
                },
                crosshair: {
                    enable: true,
                    line_color: '#62bce9'
                },
                sub_option: {
                    label: false,
                    hollow_inside: false,
                    point_size: 8
                },
                coordinate: {
                    width: 840,
                    height: 360,
                    grid_color: '#cccccc',
                    axis: {
                        color: '#cccccc',
                        width: [0, 0, 2, 2]
                    },
                    grids: {
                        vertical: {
                            way: 'share_alike',
                            value: 5
                        }
                    },
                    scale: [{
                        position: 'left',
                        scale_size: 2,
                        label: { color: '#ffffff', fontsize: 11 },
                        scale_color: '#9f9f9f'
                    }, {
                        position: 'bottom',
                        label: { color: '#ffffff', fontsize: 11 },
                        labels: labels
                    }]
                }
           });
           
             chart.setUp();
            //开始画图
            chart.draw();
        }
</script>
